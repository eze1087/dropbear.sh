#!/bin/bash
# Script para instalar y configurar Dropbear con puerto personalizado en Ubuntu 20/22/24

clear
SCPdir="/etc/VPS-MX"
SCPfrm="${SCPdir}/herramientas" && [[ ! -d ${SCPfrm} ]] && exit
SCPinst="${SCPdir}/protocolos" && [[ ! -d ${SCPinst} ]] && exit
declare -A cor=( [0]="\033[1;37m" [1]="\033[1;34m" [2]="\033[1;31m" [3]="\033[1;33m" [4]="\033[1;32m" )
cmar="\033[0m"

# Preguntar por el puerto
echo -e "${cor[1]}¿Qué puerto deseas abrir en Dropbear?${cmar}"
read -p "Puerto: " DPORT

# Validar puerto
if ! [[ "$DPORT" =~ ^[0-9]+$ ]] || [ "$DPORT" -lt 1 ] || [ "$DPORT" -gt 65535 ]; then
    echo -e "${cor[2]}Puerto inválido, se usará el puerto 22 por defecto.${cmar}"
    DPORT=22
fi

# Instalar dropbear si no está
apt update > /dev/null 2>&1
apt install -y dropbear

# Configurar Dropbear
sed -i "/^NO_START=/c\NO_START=0" /etc/default/dropbear 2>/dev/null
sed -i "/^DROPBEAR_PORT=/c\DROPBEAR_PORT=\"$DPORT\"" /etc/default/dropbear 2>/dev/null
if ! grep -q "^DROPBEAR_PORT=" /etc/default/dropbear; then
    echo "DROPBEAR_PORT=\"$DPORT\"" >> /etc/default/dropbear
fi

# Crear servicio systemd para Dropbear personalizado
cat <<EOF > /etc/systemd/system/dropbear_custom.service
[Unit]
Description=Dropbear SSH Server Custom Port
After=network.target

[Service]
Type=simple
ExecStart=/usr/sbin/dropbear -E -F -p $DPORT
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# Habilitar y arrancar el servicio
systemctl daemon-reload
systemctl enable dropbear_custom.service
systemctl start dropbear_custom.service

# Abrir el puerto en UFW
ufw allow $DPORT/tcp > /dev/null 2>&1

echo -e "${cor[4]} Dropbear configurado en puerto $DPORT y se iniciará automáticamente al reiniciar.${cmar}"
