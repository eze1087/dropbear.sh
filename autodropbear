#!/bin/bash
# **Inicio del script - compatible con Ubuntu 20, 22, 24**
clear
SCPdir="/etc/VPS-MX"
SCPfrm="${SCPdir}/herramientas" && [[ ! -d ${SCPfrm} ]] && exit
SCPinst="${SCPdir}/protocolos" && [[ ! -d ${SCPinst} ]] && exit
declare -A cor=( [0]="\033[1;37m" [1]="\033[1;34m" [2]="\033[1;31m" [3]="\033[1;33m" [4]="\033[1;32m" )
cmar="\033[0m" # Para resetear color

# Función para instalar y configurar Dropbear
fun_dropbear () {
    # Pregunta por el puerto
    echo -e "${cor[1]}$(echo -e "¿Qué puerto deseas abrir en Dropbear?")${cmar}"
    read -p "Puerto: " DPORT

    # Validar puerto
    if ! [[ "$DPORT" =~ ^[0-9]+$ ]] || [ "$DPORT" -lt 1 ] || [ "$DPORT" -gt 65535 ]; then
        echo -e "${cor[2]}Puerto inválido, se usará 22 por defecto.${cmar}"
        DPORT=22
    fi

    # Instalar Dropbear si no está
    apt update > /dev/null 2>&1
    apt install -y dropbear

    # Configurar Dropbear
    sed -i "/^NO_START=/c\NO_START=0" /etc/default/dropbear 2>/dev/null
    sed -i "/^DROPBEAR_PORT=/c\DROPBEAR_PORT=\"$DPORT\"" /etc/default/dropbear 2>/dev/null
    if ! grep -q "^DROPBEAR_PORT=" /etc/default/dropbear; then
        echo "DROPBEAR_PORT=\"$DPORT\"" >> /etc/default/dropbear
    fi

    # Reiniciar para aplicar
    systemctl restart dropbear || systemctl restart ssh || systemctl restart dropbear.service

    # Crear servicio systemd para persistencia
    cat <<EOF > /etc/systemd/system/dropbear_custom.service
[Unit]
Description=Dropbear SSH Server Custom Port
After=network.target

[Service]
Type=simple
ExecStart=/usr/sbin/dropbear -E -F -p $DPORT
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable dropbear_custom.service
    systemctl start dropbear_custom.service

    echo -e "${cor[4]} Dropbear ahora está en el puerto $DPORT y se inicia automáticamente al reiniciar.${cmar}"

    # Abrir en UFW si aplica
    ufw allow $DPORT/tcp > /dev/null 2>&1
}

# Ejecutar la función
fun_dropbear
